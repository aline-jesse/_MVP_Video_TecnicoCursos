#!/usr/bin/env node

/**
 * üß™ TESTE DE INTEGRA√á√ÉO COMPLETO
 * Sistema de Produ√ß√£o de V√≠deos - Valida√ß√£o End-to-End
 * 
 * Este script testa todas as funcionalidades cr√≠ticas do sistema:
 * - Conectividade Supabase
 * - Autentica√ß√£o
 * - Upload de arquivos
 * - Processamento PPTX
 * - Integra√ß√£o TTS (Azure + ElevenLabs)
 * - Renderiza√ß√£o de v√≠deos
 * - Storage buckets
 */

import dotenv from 'dotenv';
import { createClient } from '@supabase/supabase-js';
import fs from 'fs';
import path from 'path';

// Carregar vari√°veis de ambiente
dotenv.config();

// Configura√ß√µes
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;
const AZURE_SPEECH_KEY = process.env.AZURE_SPEECH_KEY;
const AZURE_SPEECH_REGION = process.env.AZURE_SPEECH_REGION;
const ELEVENLABS_API_KEY = process.env.ELEVENLABS_API_KEY;

// Cliente Supabase
const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

// Cores para output
const colors = {
    green: '\x1b[32m',
    red: '\x1b[31m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    cyan: '\x1b[36m',
    reset: '\x1b[0m',
    bold: '\x1b[1m'
};

function log(message, color = 'reset') {
    console.log(`${colors[color]}${message}${colors.reset}`);
}

function logSection(title) {
    console.log(`\n${colors.bold}${colors.cyan}${'='.repeat(60)}`);
    console.log(`üß™ ${title}`);
    console.log(`${'='.repeat(60)}${colors.reset}\n`);
}

function logTest(name, status, details = '') {
    const icon = status === 'pass' ? '‚úÖ' : status === 'fail' ? '‚ùå' : '‚ö†Ô∏è';
    const color = status === 'pass' ? 'green' : status === 'fail' ? 'red' : 'yellow';
    log(`${icon} ${name}`, color);
    if (details) {
        log(`   ${details}`, 'reset');
    }

    // Log detalhado de falhas
    if (status === 'fail') {
        const logMessage = `[FALHA] Teste: ${name} | Detalhes: ${details || 'N/A'}\n`;
        fs.appendFileSync(path.join(process.cwd(), 'logs', 'test-failures.log'), logMessage);
    }
}

// Resultados dos testes
const testResults = {
    total: 0,
    passed: 0,
    failed: 0,
    warnings: 0
};

function recordTest(status) {
    testResults.total++;
    if (status === 'pass') testResults.passed++;
    else if (status === 'fail') testResults.failed++;
    else testResults.warnings++;
}

async function testSupabaseConnection() {
    logSection('CONECTIVIDADE SUPABASE');
    
    try {
        // Teste 1: Verificar credenciais
        if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY) {
            logTest('Credenciais Supabase', 'fail', 'URL ou Service Key n√£o encontrados');
            recordTest('fail');
            return false;
        }
        logTest('Credenciais Supabase', 'pass', 'URL e Service Key encontrados');
        recordTest('pass');

        // Teste 2: Conectar ao Supabase
        const { data, error } = await supabase.from('render_jobs').select('count').limit(1);
        if (error) {
            logTest('Conex√£o Supabase', 'fail', error.message);
            recordTest('fail');
            return false;
        }
        logTest('Conex√£o Supabase', 'pass', 'Cliente conectado com sucesso');
        recordTest('pass');

        return true;
    } catch (error) {
        logTest('Conex√£o Supabase', 'fail', error.message);
        recordTest('fail');
        return false;
    }
}

async function testDatabaseTables() {
    logSection('VALIDA√á√ÉO DO BANCO DE DADOS');
    
    const requiredTables = [
        'users', 'projects', 'slides', 'render_jobs', 
        'analytics_events', 'nr_courses', 'nr_modules'
    ];
    
    let allTablesExist = true;
    
    for (const table of requiredTables) {
        try {
            const { data, error } = await supabase.from(table).select('count').limit(1);
            if (error) {
                logTest(`Tabela: ${table}`, 'fail', error.message);
                recordTest('fail');
                allTablesExist = false;
            } else {
                logTest(`Tabela: ${table}`, 'pass', 'Existe e acess√≠vel');
                recordTest('pass');
            }
        } catch (error) {
            logTest(`Tabela: ${table}`, 'fail', error.message);
            recordTest('fail');
            allTablesExist = false;
        }
    }
    
    return allTablesExist;
}

async function testStorageBuckets() {
    logSection('VALIDA√á√ÉO DO STORAGE');
    
    const requiredBuckets = ['avatars', 'thumbnails', 'assets', 'videos'];
    let allBucketsExist = true;
    
    try {
        const { data: buckets, error } = await supabase.storage.listBuckets();
        
        if (error) {
            logTest('Listar buckets', 'fail', error.message);
            recordTest('fail');
            return false;
        }
        
        const bucketNames = buckets.map(b => b.name);
        
        for (const bucket of requiredBuckets) {
            if (bucketNames.includes(bucket)) {
                logTest(`Bucket: ${bucket}`, 'pass', 'Existe e acess√≠vel');
                recordTest('pass');
            } else {
                logTest(`Bucket: ${bucket}`, 'fail', 'N√£o encontrado');
                recordTest('fail');
                allBucketsExist = false;
            }
        }
        
        return allBucketsExist;
    } catch (error) {
        logTest('Storage buckets', 'fail', error.message);
        recordTest('fail');
        return false;
    }
}

async function testTTSServices() {
    logSection('VALIDA√á√ÉO DOS SERVI√áOS TTS');
    
    // Teste Azure Speech Services
    if (!AZURE_SPEECH_KEY || !AZURE_SPEECH_REGION) {
        logTest('Azure Speech Services', 'fail', 'Credenciais n√£o encontradas');
        recordTest('fail');
    } else {
        logTest('Azure Speech Services', 'pass', `Regi√£o: ${AZURE_SPEECH_REGION}`);
        recordTest('pass');
    }
    
    // Teste ElevenLabs
    if (!ELEVENLABS_API_KEY) {
        logTest('ElevenLabs API', 'fail', 'API Key n√£o encontrada');
        recordTest('fail');
    } else {
        logTest('ElevenLabs API', 'pass', 'API Key configurada');
        recordTest('pass');
    }
    
    return (AZURE_SPEECH_KEY && AZURE_SPEECH_REGION && ELEVENLABS_API_KEY);
}

async function testNRCourses() {
    logSection('VALIDA√á√ÉO DOS CURSOS NR');
    
    try {
        const { data: courses, error } = await supabase
            .from('nr_courses')
            .select('course_code, title')
            .order('course_code');
        
        if (error) {
            logTest('Buscar cursos NR', 'fail', error.message);
            recordTest('fail');
            return false;
        }
        
        const expectedCourses = ['NR12', 'NR33', 'NR35'];
        const foundCourses = courses.map(c => c.course_code);
        
        for (const courseCode of expectedCourses) {
            if (foundCourses.includes(courseCode)) {
                const course = courses.find(c => c.course_code === courseCode);
                logTest(`Curso ${courseCode}`, 'pass', course.title);
                recordTest('pass');
            } else {
                logTest(`Curso ${courseCode}`, 'fail', 'N√£o encontrado');
                recordTest('fail');
            }
        }
        
        // Verificar m√≥dulos
        const { data: modules, error: modulesError } = await supabase
            .from('nr_modules')
            .select('count');
        
        if (modulesError) {
            logTest('M√≥dulos NR', 'fail', modulesError.message);
            recordTest('fail');
        } else {
            logTest('M√≥dulos NR', 'pass', `${modules.length} m√≥dulos encontrados`);
            recordTest('pass');
        }
        
        return true;
    } catch (error) {
        logTest('Cursos NR', 'fail', error.message);
        recordTest('fail');
        return false;
    }
}

async function testFileStructure() {
    logSection('VALIDA√á√ÉO DA ESTRUTURA DE ARQUIVOS');
    
    const requiredFiles = [
        'package.json',
        'next.config.js',
        'tailwind.config.js',
        '.env',
        'src/app/page.tsx',
        'src/components/ui',
        'src/lib/supabase.ts',
        'database-schema.sql',
        'database-rls-policies.sql',
        'seed-nr-courses.sql'
    ];
    
    let allFilesExist = true;
    
    for (const file of requiredFiles) {
        const filePath = path.join(process.cwd(), file);
        if (fs.existsSync(filePath)) {
            logTest(`Arquivo: ${file}`, 'pass', 'Existe');
            recordTest('pass');
        } else {
            logTest(`Arquivo: ${file}`, 'fail', 'N√£o encontrado');
            recordTest('fail');
            allFilesExist = false;
        }
    }
    
    return allFilesExist;
}

async function testEnvironmentVariables() {
    logSection('VALIDA√á√ÉO DAS VARI√ÅVEIS DE AMBIENTE');
    
    const requiredEnvVars = [
        'NEXT_PUBLIC_SUPABASE_URL',
        'NEXT_PUBLIC_SUPABASE_ANON_KEY',
        'SUPABASE_SERVICE_ROLE_KEY',
        'NEXTAUTH_SECRET',
        'AZURE_SPEECH_KEY',
        'AZURE_SPEECH_REGION',
        'ELEVENLABS_API_KEY'
    ];
    
    let allVarsExist = true;
    
    for (const envVar of requiredEnvVars) {
        const value = process.env[envVar];
        if (value && value.length > 0) {
            const maskedValue = value.length > 10 ? 
                `${value.substring(0, 8)}...${value.substring(value.length - 4)}` : 
                '***';
            logTest(`${envVar}`, 'pass', maskedValue);
            recordTest('pass');
        } else {
            logTest(`${envVar}`, 'fail', 'N√£o definida ou vazia');
            recordTest('fail');
            allVarsExist = false;
        }
    }
    
    return allVarsExist;
}

function generateReport() {
    logSection('RELAT√ìRIO FINAL DOS TESTES');
    
    const successRate = ((testResults.passed / testResults.total) * 100).toFixed(1);
    
    log(`üìä Total de testes: ${testResults.total}`, 'blue');
    log(`‚úÖ Aprovados: ${testResults.passed}`, 'green');
    log(`‚ùå Falharam: ${testResults.failed}`, 'red');
    log(`‚ö†Ô∏è Avisos: ${testResults.warnings}`, 'yellow');
    log(`üìà Taxa de sucesso: ${successRate}%`, 'cyan');
    
    console.log('\n' + '='.repeat(60));
    
    if (testResults.failed === 0) {
        log('üéâ TODOS OS TESTES PASSARAM!', 'green');
        log('‚úÖ Sistema pronto para uso em produ√ß√£o', 'green');
    } else if (testResults.failed <= 2) {
        log('‚ö†Ô∏è ALGUNS TESTES FALHARAM', 'yellow');
        log('üîß Corre√ß√µes menores necess√°rias', 'yellow');
    } else {
        log('‚ùå MUITOS TESTES FALHARAM', 'red');
        log('üö® Configura√ß√£o cr√≠tica necess√°ria', 'red');
    }
    
    console.log('='.repeat(60));
}

async function runAllTests() {
    log('üöÄ INICIANDO TESTES DE INTEGRA√á√ÉO COMPLETOS', 'bold');
    log('Sistema de Produ√ß√£o de V√≠deos - Valida√ß√£o End-to-End\n', 'cyan');
    
    try {
        // Executar todos os testes
        await testEnvironmentVariables();
        await testFileStructure();
        await testSupabaseConnection();
        await testDatabaseTables();
        await testStorageBuckets();
        await testTTSServices();
        await testNRCourses();
        
        // Gerar relat√≥rio final
        generateReport();
        
        // Retornar c√≥digo de sa√≠da apropriado
        process.exit(testResults.failed === 0 ? 0 : 1);
        
    } catch (error) {
        log(`\n‚ùå ERRO CR√çTICO: ${error.message}`, 'red');
        process.exit(1);
    }
}

// Executar testes se chamado diretamente
runAllTests();

export { runAllTests, testResults };